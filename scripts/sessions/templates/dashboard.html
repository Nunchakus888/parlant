
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parlant å®æ—¶ç›‘æ§ä»ªè¡¨æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric-label {
            color: #666;
            font-size: 0.9em;
        }
        .status-healthy { color: #28a745; }
        .status-unhealthy { color: #dc3545; }
        .status-unknown { color: #ffc107; }
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .details-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .details-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .details-panel h3 {
            margin: 0 0 15px 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .details-content {
            max-height: 300px;
            overflow-y: auto;
        }
        .thread-item, .connection-item {
            background: #f8f9fa;
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .thread-item.active {
            border-left-color: #28a745;
        }
        .thread-item.idle {
            border-left-color: #6c757d;
        }
        .connection-item.listening {
            border-left-color: #17a2b8;
        }
        .connection-item.established {
            border-left-color: #28a745;
        }
        .connection-item.time_wait {
            border-left-color: #ffc107;
        }
        .metric-label-small {
            font-size: 0.8em;
            color: #666;
            margin-right: 10px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
        }
        .connected { background-color: #28a745; }
        .disconnected { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">è¿æ¥ä¸­...</div>
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">ç³»ç»Ÿ CPU ä½¿ç”¨ç‡</div>
            <div class="metric-value" id="systemCpu">--</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡</div>
            <div class="metric-value" id="systemMemory">--</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">åº”ç”¨å†…å­˜</div>
            <div class="metric-value" id="appMemory">--</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">æœåŠ¡çŠ¶æ€</div>
            <div class="metric-value" id="serviceStatus">--</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">å“åº”æ—¶é—´</div>
            <div class="metric-value" id="responseTime">--</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">æ´»è·ƒè¿æ¥</div>
            <div class="metric-value" id="connections">--</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">çº¿ç¨‹æ•°</div>
            <div class="metric-value" id="threads">--</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">æ–‡ä»¶æè¿°ç¬¦</div>
            <div class="metric-value" id="fileDescriptors">--</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">TPS</div>
            <div class="metric-value" id="tps">--</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">è´Ÿè½½å› å­</div>
            <div class="metric-value" id="loadFactor">--</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">å¹¶å‘åº¦</div>
            <div class="metric-value" id="concurrency">--</div>
        </div>
    </div>
    
    <div class="charts-container">
        <div class="chart-container">
            <div id="cpuChart"></div>
        </div>
        <div class="chart-container">
            <div id="memoryChart"></div>
        </div>
        <div class="chart-container full-width">
            <div id="responseTimeChart"></div>
        </div>
        <div class="chart-container full-width">
            <div id="performanceChart"></div>
        </div>
    </div>
    
    <!-- è¯¦ç»†ä¿¡æ¯é¢æ¿ -->
    <div class="details-container">
        <div class="details-panel">
            <h3>ğŸ“Š çº¿ç¨‹è¯¦ç»†ä¿¡æ¯</h3>
            <div id="threadsDetails" class="details-content">
                <p>æ­£åœ¨åŠ è½½çº¿ç¨‹ä¿¡æ¯...</p>
            </div>
        </div>
        
        <div class="details-panel">
            <h3>ğŸ”— è¿æ¥è¯¦ç»†ä¿¡æ¯</h3>
            <div id="connectionsDetails" class="details-content">
                <p>æ­£åœ¨åŠ è½½è¿æ¥ä¿¡æ¯...</p>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let charts = {};
        
        // è¿æ¥çŠ¶æ€ç®¡ç†
        socket.on('connect', function() {
            document.getElementById('connectionStatus').textContent = 'å·²è¿æ¥';
            document.getElementById('connectionStatus').className = 'connection-status connected';
        });
        
        socket.on('disconnect', function() {
            document.getElementById('connectionStatus').textContent = 'è¿æ¥æ–­å¼€';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
        });
        
        // æ›´æ–°æŒ‡æ ‡æ˜¾ç¤º
        socket.on('metrics_update', function(data) {
            updateMetrics(data);
        });
        
        function updateMetrics(data) {
            document.getElementById('systemCpu').textContent = data.system.cpu_percent.toFixed(1) + '%';
            document.getElementById('systemMemory').textContent = data.system.memory_percent.toFixed(1) + '%';
            document.getElementById('appMemory').textContent = data.application.memory_mb.toFixed(1) + ' MB';
            document.getElementById('responseTime').textContent = data.health.response_time_ms.toFixed(0) + ' ms';
            document.getElementById('connections').textContent = data.application.connections;
            document.getElementById('threads').textContent = data.application.threads;
            document.getElementById('fileDescriptors').textContent = data.application.file_descriptors;
            document.getElementById('tps').textContent = data.performance.tps;
            document.getElementById('loadFactor').textContent = (data.performance.load_factor * 100).toFixed(1) + '%';
            document.getElementById('concurrency').textContent = data.performance.concurrency;
            
            const statusElement = document.getElementById('serviceStatus');
            statusElement.textContent = data.health.status;
            statusElement.className = 'metric-value status-' + data.health.status;
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // CPU å›¾è¡¨
            fetch('/api/charts/cpu')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('CPU chart error:', data.error);
                        return;
                    }
                    Plotly.newPlot('cpuChart', data.data, data.layout, {responsive: true});
                });
            
            // å†…å­˜å›¾è¡¨
            fetch('/api/charts/memory')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Memory chart error:', data.error);
                        return;
                    }
                    Plotly.newPlot('memoryChart', data.data, data.layout, {responsive: true});
                });
            
            // å“åº”æ—¶é—´å›¾è¡¨
            fetch('/api/charts/response_time')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Response time chart error:', data.error);
                        return;
                    }
                    Plotly.newPlot('responseTimeChart', data.data, data.layout, {responsive: true});
                });
            
            // æ€§èƒ½æŒ‡æ ‡å›¾è¡¨
            fetch('/api/charts/performance')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Performance chart error:', data.error);
                        return;
                    }
                    Plotly.newPlot('performanceChart', data.data, data.layout, {responsive: true});
                });
        }
        
        // åŠ è½½è¯¦ç»†ä¿¡æ¯
        function loadDetails() {
            // åŠ è½½çº¿ç¨‹ä¿¡æ¯
            fetch('/api/threads')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('threadsDetails').innerHTML = '<p>âŒ æ— æ³•åŠ è½½çº¿ç¨‹ä¿¡æ¯: ' + data.error + '</p>';
                        return;
                    }
                    displayThreads(data);
                })
                .catch(error => {
                    document.getElementById('threadsDetails').innerHTML = '<p>âŒ åŠ è½½çº¿ç¨‹ä¿¡æ¯å¤±è´¥</p>';
                });
            
            // åŠ è½½è¿æ¥ä¿¡æ¯
            fetch('/api/connections')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('connectionsDetails').innerHTML = '<p>âŒ æ— æ³•åŠ è½½è¿æ¥ä¿¡æ¯: ' + data.error + '</p>';
                        return;
                    }
                    displayConnections(data);
                })
                .catch(error => {
                    document.getElementById('connectionsDetails').innerHTML = '<p>âŒ åŠ è½½è¿æ¥ä¿¡æ¯å¤±è´¥</p>';
                });
        }
        
        function displayThreads(data) {
            console.log('Thread data:', data); // è°ƒè¯•ä¿¡æ¯
            
            let html = '<div class="metric-card"><div class="metric-label">æ€»çº¿ç¨‹æ•°</div><div class="metric-value">' + (data.total || 0) + '</div></div>';
            
            if (data.note) {
                html += '<p style="color: #666; font-size: 0.9em;">' + data.note + '</p>';
            }
            
            if (data.details && data.details.length > 0) {
                html += '<h4>çº¿ç¨‹è¯¦æƒ…:</h4>';
                data.details.forEach(thread => {
                    const statusClass = thread.status === 'active' ? 'active' : 'idle';
                    html += '<div class="thread-item ' + statusClass + '">';
                    html += '<span class="metric-label-small">ID:</span>' + thread.id + ' ';
                    html += '<span class="metric-label-small">çŠ¶æ€:</span>' + thread.status + ' ';
                    html += '<span class="metric-label-small">ç”¨æˆ·æ—¶é—´:</span>' + thread.user_time.toFixed(2) + 's ';
                    html += '<span class="metric-label-small">ç³»ç»Ÿæ—¶é—´:</span>' + thread.system_time.toFixed(2) + 's';
                    html += '</div>';
                });
            } else if (data.total > 0) {
                html += '<p style="color: #666; font-size: 0.9em;">çº¿ç¨‹è¯¦æƒ…ä¸å¯ç”¨ï¼Œä½†æ£€æµ‹åˆ° ' + data.total + ' ä¸ªçº¿ç¨‹</p>';
            }
            
            document.getElementById('threadsDetails').innerHTML = html;
        }
        
        function displayConnections(data) {
            console.log('Connection data:', data); // è°ƒè¯•ä¿¡æ¯
            
            let html = '<div class="metric-card"><div class="metric-label">æ€»è¿æ¥æ•°</div><div class="metric-value">' + (data.total || 0) + '</div></div>';
            
            // è¿æ¥ç±»å‹ç»Ÿè®¡
            html += '<div class="metric-card"><div class="metric-label">ç›‘å¬</div><div class="metric-value">' + (data.listening || 0) + '</div></div>';
            html += '<div class="metric-card"><div class="metric-label">å·²å»ºç«‹</div><div class="metric-value">' + (data.established || 0) + '</div></div>';
            html += '<div class="metric-card"><div class="metric-label">ç­‰å¾…å…³é—­</div><div class="metric-value">' + (data.time_wait || 0) + '</div></div>';
            
            if (data.listening_ports && data.listening_ports.length > 0) {
                html += '<h4>ç›‘å¬ç«¯å£:</h4><p>' + data.listening_ports.join(', ') + '</p>';
            }
            
            if (data.details && data.details.length > 0) {
                html += '<h4>è¿æ¥è¯¦æƒ…:</h4>';
                data.details.forEach(conn => {
                    const statusClass = conn.status.toLowerCase().replace('_', '');
                    html += '<div class="connection-item ' + statusClass + '">';
                    html += '<span class="metric-label-small">çŠ¶æ€:</span>' + conn.status + ' ';
                    html += '<span class="metric-label-small">æœ¬åœ°:</span>' + conn.local_addr + ' ';
                    html += '<span class="metric-label-small">è¿œç¨‹:</span>' + conn.remote_addr + ' ';
                    html += '<span class="metric-label-small">ç±»å‹:</span>' + conn.type + '/' + conn.family;
                    html += '</div>';
                });
            }
            
            document.getElementById('connectionsDetails').innerHTML = html;
        }
        
        // å®šæœŸæ›´æ–°å›¾è¡¨å’Œè¯¦ç»†ä¿¡æ¯
        setInterval(initCharts, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
        setInterval(loadDetails, 10000); // æ¯10ç§’æ›´æ–°è¯¦ç»†ä¿¡æ¯
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadDetails();
        });
    </script>
</body>
</html>
    