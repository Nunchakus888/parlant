# 1000会话实例压力测试规划

## 🎯 测试目标

设计并实施一个全面的1000个会话实例压力测试方案，验证系统在高并发场景下的性能表现，同时避免触发429限流。

## 📊 系统现状分析

### 限流机制
- **Chat接口限流**: 30次/分钟 (CREATE_CUSTOMER_EVENT)
- **会话创建限流**: 10次/分钟 (CREATE_GUEST_SESSION)
- **默认限流**: 100次/分钟
- **限流类型**: 基于IP地址的移动窗口限流

### 会话管理
- **Agent创建**: 每个会话创建独立Agent实例
- **内存管理**: LRU机制，最大1000个会话
- **存储**: MongoDB文档存储
- **事件驱动**: 基于事件的状态管理

## 🏗️ 测试架构设计

### 核心组件

#### 1. 智能频次控制器 (RateController)
```python
class RateController:
    - 基于IP地址的分布式限流
    - 动态速率调整 (adaptive_rate_multiplier)
    - 指数退避重试机制
    - 实时限流率监控
```

**关键特性**:
- 多IP地址池支持 (默认10个IP)
- 自适应速率调整 (0.8x - 1.1x)
- 30秒调整周期
- 限流率阈值: 10% (降低) / 1% (提高)

#### 2. IP地址池 (IPPool)
```python
class IPPool:
    - 轮询IP分配
    - 支持自定义IP数量
    - 模拟真实多IP环境
```

#### 3. 会话管理器 (SessionManager)
```python
class SessionManager:
    - 会话生命周期管理
    - 活跃会话追踪
    - 自动清理过期会话
    - 会话统计信息
```

### 测试策略

#### 渐进式负载增长
1. **启动阶段** (0-5分钟): 创建基础会话池
2. **增长阶段** (5-30分钟): 逐步增加会话数量
3. **稳定阶段** (30-55分钟): 维持目标会话数
4. **清理阶段** (55-60分钟): 清理过期会话

#### 智能请求分发
- **新会话创建**: 优先创建新会话
- **消息发送**: 向现有活跃会话发送消息
- **频次控制**: 基于IP地址的智能限流
- **负载均衡**: 均匀分布请求到不同IP

## 📋 测试场景设计

### 1. 轻负载测试 (light_load)
- **目标**: 验证基础功能
- **会话数**: 100
- **时长**: 10分钟
- **IP数**: 5
- **预期限流率**: 0%
- **预期成功率**: 99%

### 2. 中等负载测试 (medium_load)
- **目标**: 验证中等并发性能
- **会话数**: 500
- **时长**: 30分钟
- **IP数**: 10
- **预期限流率**: 5%
- **预期成功率**: 95%

### 3. 重负载测试 (heavy_load)
- **目标**: 验证高并发性能
- **会话数**: 1000
- **时长**: 60分钟
- **IP数**: 20
- **预期限流率**: 10%
- **预期成功率**: 90%

### 4. 压力测试 (stress_test)
- **目标**: 测试系统极限
- **会话数**: 1000
- **时长**: 120分钟
- **IP数**: 50
- **预期限流率**: 20%
- **预期成功率**: 85%

### 5. 耐久性测试 (endurance_test)
- **目标**: 检查内存泄漏
- **会话数**: 1000
- **时长**: 240分钟 (4小时)
- **IP数**: 15
- **预期限流率**: 5%
- **预期成功率**: 95%

### 6. 突发测试 (burst_test)
- **目标**: 测试系统恢复能力
- **会话数**: 1000
- **时长**: 5分钟
- **IP数**: 100
- **预期限流率**: 30%
- **预期成功率**: 80%

## 🔧 技术实现细节

### 频次控制算法

#### 基础速率计算
```python
rate_per_ip_per_minute = base_rate_per_minute // ip_count
rate_per_ip_per_second = rate_per_ip_per_minute / 60.0
```

#### 动态调整策略
```python
if rate_limit_ratio > 0.1:  # 限流率超过10%
    adaptive_rate_multiplier *= 0.8  # 降低20%
elif rate_limit_ratio < 0.01:  # 限流率低于1%
    adaptive_rate_multiplier *= 1.1  # 提高10%
```

#### 请求间隔控制
```python
min_interval = 1.0 / (rate_per_ip_per_second * adaptive_rate_multiplier)
```

### 会话管理策略

#### 会话创建优先级
1. 检查当前会话数是否达到上限
2. 选择下一个可用IP地址
3. 创建新会话实例
4. 发送第一条消息建立会话
5. 记录会话到活跃列表

#### 消息发送策略
1. 从活跃会话中随机选择
2. 检查该IP的请求频次限制
3. 发送消息并更新会话状态
4. 记录请求历史

#### 会话清理机制
- **定期清理**: 每5分钟清理一次过期会话
- **过期时间**: 1小时无活动
- **清理策略**: 删除会话和关联Agent

## 📈 监控指标

### 实时监控
- **会话统计**: 总会话数、活跃会话数、峰值并发
- **请求统计**: 总请求数、成功数、失败数、限流数
- **性能指标**: 响应时间、请求速率、会话创建速率
- **系统状态**: 限流率、成功率、速率倍数

### 关键指标阈值
- **成功率**: ≥ 90% (重负载), ≥ 95% (中等负载)
- **限流率**: ≤ 20% (压力测试), ≤ 10% (重负载)
- **响应时间**: P95 < 5s, P99 < 10s
- **会话创建速率**: ≥ 0.5 sessions/s

## 🚀 使用方法

### 快速开始
```bash
# 列出所有可用场景
./scripts/run_1000_sessions_test.sh --list

# 运行轻负载测试
./scripts/run_1000_sessions_test.sh light_load

# 运行重负载测试
./scripts/run_1000_sessions_test.sh heavy_load

# 指定服务器和输出目录
./scripts/run_1000_sessions_test.sh -s http://prod-server:8800 -o /tmp/results stress_test
```

### 直接使用Python脚本
```bash
# 运行1000会话测试
python load_test_1000_sessions.py --sessions 1000 --duration 3600 --ip-count 20

# 运行场景测试
python test_scenarios_1000_sessions.py --scenario heavy_load
```

## 📊 结果分析

### 性能报告
- **测试概览**: 时长、会话数、请求数
- **成功率分析**: 总体成功率、分类成功率
- **限流分析**: 限流率、限流分布
- **响应时间**: 平均值、百分位数
- **吞吐量**: 请求速率、会话创建速率

### 优化建议
- **限流率过高**: 增加IP数量、降低请求频率
- **成功率过低**: 检查服务器资源、优化数据库
- **响应时间过长**: 检查网络延迟、优化模型性能
- **内存使用过高**: 检查会话清理机制、优化Agent管理

## ⚠️ 注意事项

### 测试环境要求
- **服务器资源**: 至少8GB内存，4核CPU
- **网络环境**: 稳定的网络连接
- **数据库**: MongoDB连接池配置
- **模型服务**: 足够的GPU/CPU资源

### 安全考虑
- **IP地址**: 使用内网IP地址池
- **数据隔离**: 使用测试专用的租户ID
- **资源限制**: 设置合理的超时时间
- **监控告警**: 设置资源使用告警

### 故障处理
- **429限流**: 自动重试，动态调整速率
- **连接超时**: 指数退避重试
- **服务器错误**: 记录错误，继续测试
- **内存不足**: 自动清理过期会话

## 🔄 持续优化

### 参数调优
- **IP数量**: 根据限流配置调整
- **速率倍数**: 基于实际限流率调整
- **清理周期**: 根据内存使用情况调整
- **超时时间**: 根据网络环境调整

### 扩展功能
- **多租户测试**: 支持多个租户并发测试
- **自定义消息**: 支持业务相关的测试消息
- **性能基准**: 建立性能基准线
- **自动化报告**: 集成到CI/CD流程

## 📚 相关文档

- [API限流机制](./production/api-hardening.md)
- [会话管理架构](./concepts/sessions.md)
- [LRU内存管理](./lru-memory-management.md)
- [性能优化总结](./optimization_summary.md)
