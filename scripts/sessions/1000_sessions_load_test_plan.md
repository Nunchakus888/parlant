# 1000ä¼šè¯å®ä¾‹å‹åŠ›æµ‹è¯•è§„åˆ’

## ğŸ¯ æµ‹è¯•ç›®æ ‡

è®¾è®¡å¹¶å®æ–½ä¸€ä¸ªå…¨é¢çš„1000ä¸ªä¼šè¯å®ä¾‹å‹åŠ›æµ‹è¯•æ–¹æ¡ˆï¼ŒéªŒè¯ç³»ç»Ÿåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½è¡¨ç°ï¼ŒåŒæ—¶é¿å…è§¦å‘429é™æµã€‚

## ğŸ“Š ç³»ç»Ÿç°çŠ¶åˆ†æ

### é™æµæœºåˆ¶
- **Chatæ¥å£é™æµ**: 30æ¬¡/åˆ†é’Ÿ (CREATE_CUSTOMER_EVENT)
- **ä¼šè¯åˆ›å»ºé™æµ**: 10æ¬¡/åˆ†é’Ÿ (CREATE_GUEST_SESSION)
- **é»˜è®¤é™æµ**: 100æ¬¡/åˆ†é’Ÿ
- **é™æµç±»å‹**: åŸºäºIPåœ°å€çš„ç§»åŠ¨çª—å£é™æµ

### ä¼šè¯ç®¡ç†
- **Agentåˆ›å»º**: æ¯ä¸ªä¼šè¯åˆ›å»ºç‹¬ç«‹Agentå®ä¾‹
- **å†…å­˜ç®¡ç†**: LRUæœºåˆ¶ï¼Œæœ€å¤§1000ä¸ªä¼šè¯
- **å­˜å‚¨**: MongoDBæ–‡æ¡£å­˜å‚¨
- **äº‹ä»¶é©±åŠ¨**: åŸºäºäº‹ä»¶çš„çŠ¶æ€ç®¡ç†

## ğŸ—ï¸ æµ‹è¯•æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

#### 1. æ™ºèƒ½é¢‘æ¬¡æ§åˆ¶å™¨ (RateController)
```python
class RateController:
    - åŸºäºIPåœ°å€çš„åˆ†å¸ƒå¼é™æµ
    - åŠ¨æ€é€Ÿç‡è°ƒæ•´ (adaptive_rate_multiplier)
    - æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶
    - å®æ—¶é™æµç‡ç›‘æ§
```

**å…³é”®ç‰¹æ€§**:
- å¤šIPåœ°å€æ± æ”¯æŒ (é»˜è®¤10ä¸ªIP)
- è‡ªé€‚åº”é€Ÿç‡è°ƒæ•´ (0.8x - 1.1x)
- 30ç§’è°ƒæ•´å‘¨æœŸ
- é™æµç‡é˜ˆå€¼: 10% (é™ä½) / 1% (æé«˜)

#### 2. IPåœ°å€æ±  (IPPool)
```python
class IPPool:
    - è½®è¯¢IPåˆ†é…
    - æ”¯æŒè‡ªå®šä¹‰IPæ•°é‡
    - æ¨¡æ‹ŸçœŸå®å¤šIPç¯å¢ƒ
```

#### 3. ä¼šè¯ç®¡ç†å™¨ (SessionManager)
```python
class SessionManager:
    - ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
    - æ´»è·ƒä¼šè¯è¿½è¸ª
    - è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯
    - ä¼šè¯ç»Ÿè®¡ä¿¡æ¯
```

### æµ‹è¯•ç­–ç•¥

#### æ¸è¿›å¼è´Ÿè½½å¢é•¿
1. **å¯åŠ¨é˜¶æ®µ** (0-5åˆ†é’Ÿ): åˆ›å»ºåŸºç¡€ä¼šè¯æ± 
2. **å¢é•¿é˜¶æ®µ** (5-30åˆ†é’Ÿ): é€æ­¥å¢åŠ ä¼šè¯æ•°é‡
3. **ç¨³å®šé˜¶æ®µ** (30-55åˆ†é’Ÿ): ç»´æŒç›®æ ‡ä¼šè¯æ•°
4. **æ¸…ç†é˜¶æ®µ** (55-60åˆ†é’Ÿ): æ¸…ç†è¿‡æœŸä¼šè¯

#### æ™ºèƒ½è¯·æ±‚åˆ†å‘
- **æ–°ä¼šè¯åˆ›å»º**: ä¼˜å…ˆåˆ›å»ºæ–°ä¼šè¯
- **æ¶ˆæ¯å‘é€**: å‘ç°æœ‰æ´»è·ƒä¼šè¯å‘é€æ¶ˆæ¯
- **é¢‘æ¬¡æ§åˆ¶**: åŸºäºIPåœ°å€çš„æ™ºèƒ½é™æµ
- **è´Ÿè½½å‡è¡¡**: å‡åŒ€åˆ†å¸ƒè¯·æ±‚åˆ°ä¸åŒIP

## ğŸ“‹ æµ‹è¯•åœºæ™¯è®¾è®¡

### 1. è½»è´Ÿè½½æµ‹è¯• (light_load)
- **ç›®æ ‡**: éªŒè¯åŸºç¡€åŠŸèƒ½
- **ä¼šè¯æ•°**: 100
- **æ—¶é•¿**: 10åˆ†é’Ÿ
- **IPæ•°**: 5
- **é¢„æœŸé™æµç‡**: 0%
- **é¢„æœŸæˆåŠŸç‡**: 99%

### 2. ä¸­ç­‰è´Ÿè½½æµ‹è¯• (medium_load)
- **ç›®æ ‡**: éªŒè¯ä¸­ç­‰å¹¶å‘æ€§èƒ½
- **ä¼šè¯æ•°**: 500
- **æ—¶é•¿**: 30åˆ†é’Ÿ
- **IPæ•°**: 10
- **é¢„æœŸé™æµç‡**: 5%
- **é¢„æœŸæˆåŠŸç‡**: 95%

### 3. é‡è´Ÿè½½æµ‹è¯• (heavy_load)
- **ç›®æ ‡**: éªŒè¯é«˜å¹¶å‘æ€§èƒ½
- **ä¼šè¯æ•°**: 1000
- **æ—¶é•¿**: 60åˆ†é’Ÿ
- **IPæ•°**: 20
- **é¢„æœŸé™æµç‡**: 10%
- **é¢„æœŸæˆåŠŸç‡**: 90%

### 4. å‹åŠ›æµ‹è¯• (stress_test)
- **ç›®æ ‡**: æµ‹è¯•ç³»ç»Ÿæé™
- **ä¼šè¯æ•°**: 1000
- **æ—¶é•¿**: 120åˆ†é’Ÿ
- **IPæ•°**: 50
- **é¢„æœŸé™æµç‡**: 20%
- **é¢„æœŸæˆåŠŸç‡**: 85%

### 5. è€ä¹…æ€§æµ‹è¯• (endurance_test)
- **ç›®æ ‡**: æ£€æŸ¥å†…å­˜æ³„æ¼
- **ä¼šè¯æ•°**: 1000
- **æ—¶é•¿**: 240åˆ†é’Ÿ (4å°æ—¶)
- **IPæ•°**: 15
- **é¢„æœŸé™æµç‡**: 5%
- **é¢„æœŸæˆåŠŸç‡**: 95%

### 6. çªå‘æµ‹è¯• (burst_test)
- **ç›®æ ‡**: æµ‹è¯•ç³»ç»Ÿæ¢å¤èƒ½åŠ›
- **ä¼šè¯æ•°**: 1000
- **æ—¶é•¿**: 5åˆ†é’Ÿ
- **IPæ•°**: 100
- **é¢„æœŸé™æµç‡**: 30%
- **é¢„æœŸæˆåŠŸç‡**: 80%

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### é¢‘æ¬¡æ§åˆ¶ç®—æ³•

#### åŸºç¡€é€Ÿç‡è®¡ç®—
```python
rate_per_ip_per_minute = base_rate_per_minute // ip_count
rate_per_ip_per_second = rate_per_ip_per_minute / 60.0
```

#### åŠ¨æ€è°ƒæ•´ç­–ç•¥
```python
if rate_limit_ratio > 0.1:  # é™æµç‡è¶…è¿‡10%
    adaptive_rate_multiplier *= 0.8  # é™ä½20%
elif rate_limit_ratio < 0.01:  # é™æµç‡ä½äº1%
    adaptive_rate_multiplier *= 1.1  # æé«˜10%
```

#### è¯·æ±‚é—´éš”æ§åˆ¶
```python
min_interval = 1.0 / (rate_per_ip_per_second * adaptive_rate_multiplier)
```

### ä¼šè¯ç®¡ç†ç­–ç•¥

#### ä¼šè¯åˆ›å»ºä¼˜å…ˆçº§
1. æ£€æŸ¥å½“å‰ä¼šè¯æ•°æ˜¯å¦è¾¾åˆ°ä¸Šé™
2. é€‰æ‹©ä¸‹ä¸€ä¸ªå¯ç”¨IPåœ°å€
3. åˆ›å»ºæ–°ä¼šè¯å®ä¾‹
4. å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å»ºç«‹ä¼šè¯
5. è®°å½•ä¼šè¯åˆ°æ´»è·ƒåˆ—è¡¨

#### æ¶ˆæ¯å‘é€ç­–ç•¥
1. ä»æ´»è·ƒä¼šè¯ä¸­éšæœºé€‰æ‹©
2. æ£€æŸ¥è¯¥IPçš„è¯·æ±‚é¢‘æ¬¡é™åˆ¶
3. å‘é€æ¶ˆæ¯å¹¶æ›´æ–°ä¼šè¯çŠ¶æ€
4. è®°å½•è¯·æ±‚å†å²

#### ä¼šè¯æ¸…ç†æœºåˆ¶
- **å®šæœŸæ¸…ç†**: æ¯5åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡è¿‡æœŸä¼šè¯
- **è¿‡æœŸæ—¶é—´**: 1å°æ—¶æ— æ´»åŠ¨
- **æ¸…ç†ç­–ç•¥**: åˆ é™¤ä¼šè¯å’Œå…³è”Agent

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### å®æ—¶ç›‘æ§
- **ä¼šè¯ç»Ÿè®¡**: æ€»ä¼šè¯æ•°ã€æ´»è·ƒä¼šè¯æ•°ã€å³°å€¼å¹¶å‘
- **è¯·æ±‚ç»Ÿè®¡**: æ€»è¯·æ±‚æ•°ã€æˆåŠŸæ•°ã€å¤±è´¥æ•°ã€é™æµæ•°
- **æ€§èƒ½æŒ‡æ ‡**: å“åº”æ—¶é—´ã€è¯·æ±‚é€Ÿç‡ã€ä¼šè¯åˆ›å»ºé€Ÿç‡
- **ç³»ç»ŸçŠ¶æ€**: é™æµç‡ã€æˆåŠŸç‡ã€é€Ÿç‡å€æ•°

### å…³é”®æŒ‡æ ‡é˜ˆå€¼
- **æˆåŠŸç‡**: â‰¥ 90% (é‡è´Ÿè½½), â‰¥ 95% (ä¸­ç­‰è´Ÿè½½)
- **é™æµç‡**: â‰¤ 20% (å‹åŠ›æµ‹è¯•), â‰¤ 10% (é‡è´Ÿè½½)
- **å“åº”æ—¶é—´**: P95 < 5s, P99 < 10s
- **ä¼šè¯åˆ›å»ºé€Ÿç‡**: â‰¥ 0.5 sessions/s

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¼€å§‹
```bash
# åˆ—å‡ºæ‰€æœ‰å¯ç”¨åœºæ™¯
./scripts/run_1000_sessions_test.sh --list

# è¿è¡Œè½»è´Ÿè½½æµ‹è¯•
./scripts/run_1000_sessions_test.sh light_load

# è¿è¡Œé‡è´Ÿè½½æµ‹è¯•
./scripts/run_1000_sessions_test.sh heavy_load

# æŒ‡å®šæœåŠ¡å™¨å’Œè¾“å‡ºç›®å½•
./scripts/run_1000_sessions_test.sh -s http://prod-server:8800 -o /tmp/results stress_test
```

### ç›´æ¥ä½¿ç”¨Pythonè„šæœ¬
```bash
# è¿è¡Œ1000ä¼šè¯æµ‹è¯•
python load_test_1000_sessions.py --sessions 1000 --duration 3600 --ip-count 20

# è¿è¡Œåœºæ™¯æµ‹è¯•
python test_scenarios_1000_sessions.py --scenario heavy_load
```

## ğŸ“Š ç»“æœåˆ†æ

### æ€§èƒ½æŠ¥å‘Š
- **æµ‹è¯•æ¦‚è§ˆ**: æ—¶é•¿ã€ä¼šè¯æ•°ã€è¯·æ±‚æ•°
- **æˆåŠŸç‡åˆ†æ**: æ€»ä½“æˆåŠŸç‡ã€åˆ†ç±»æˆåŠŸç‡
- **é™æµåˆ†æ**: é™æµç‡ã€é™æµåˆ†å¸ƒ
- **å“åº”æ—¶é—´**: å¹³å‡å€¼ã€ç™¾åˆ†ä½æ•°
- **ååé‡**: è¯·æ±‚é€Ÿç‡ã€ä¼šè¯åˆ›å»ºé€Ÿç‡

### ä¼˜åŒ–å»ºè®®
- **é™æµç‡è¿‡é«˜**: å¢åŠ IPæ•°é‡ã€é™ä½è¯·æ±‚é¢‘ç‡
- **æˆåŠŸç‡è¿‡ä½**: æ£€æŸ¥æœåŠ¡å™¨èµ„æºã€ä¼˜åŒ–æ•°æ®åº“
- **å“åº”æ—¶é—´è¿‡é•¿**: æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿã€ä¼˜åŒ–æ¨¡å‹æ€§èƒ½
- **å†…å­˜ä½¿ç”¨è¿‡é«˜**: æ£€æŸ¥ä¼šè¯æ¸…ç†æœºåˆ¶ã€ä¼˜åŒ–Agentç®¡ç†

## âš ï¸ æ³¨æ„äº‹é¡¹

### æµ‹è¯•ç¯å¢ƒè¦æ±‚
- **æœåŠ¡å™¨èµ„æº**: è‡³å°‘8GBå†…å­˜ï¼Œ4æ ¸CPU
- **ç½‘ç»œç¯å¢ƒ**: ç¨³å®šçš„ç½‘ç»œè¿æ¥
- **æ•°æ®åº“**: MongoDBè¿æ¥æ± é…ç½®
- **æ¨¡å‹æœåŠ¡**: è¶³å¤Ÿçš„GPU/CPUèµ„æº

### å®‰å…¨è€ƒè™‘
- **IPåœ°å€**: ä½¿ç”¨å†…ç½‘IPåœ°å€æ± 
- **æ•°æ®éš”ç¦»**: ä½¿ç”¨æµ‹è¯•ä¸“ç”¨çš„ç§Ÿæˆ·ID
- **èµ„æºé™åˆ¶**: è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- **ç›‘æ§å‘Šè­¦**: è®¾ç½®èµ„æºä½¿ç”¨å‘Šè­¦

### æ•…éšœå¤„ç†
- **429é™æµ**: è‡ªåŠ¨é‡è¯•ï¼ŒåŠ¨æ€è°ƒæ•´é€Ÿç‡
- **è¿æ¥è¶…æ—¶**: æŒ‡æ•°é€€é¿é‡è¯•
- **æœåŠ¡å™¨é”™è¯¯**: è®°å½•é”™è¯¯ï¼Œç»§ç»­æµ‹è¯•
- **å†…å­˜ä¸è¶³**: è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯

## ğŸ”„ æŒç»­ä¼˜åŒ–

### å‚æ•°è°ƒä¼˜
- **IPæ•°é‡**: æ ¹æ®é™æµé…ç½®è°ƒæ•´
- **é€Ÿç‡å€æ•°**: åŸºäºå®é™…é™æµç‡è°ƒæ•´
- **æ¸…ç†å‘¨æœŸ**: æ ¹æ®å†…å­˜ä½¿ç”¨æƒ…å†µè°ƒæ•´
- **è¶…æ—¶æ—¶é—´**: æ ¹æ®ç½‘ç»œç¯å¢ƒè°ƒæ•´

### æ‰©å±•åŠŸèƒ½
- **å¤šç§Ÿæˆ·æµ‹è¯•**: æ”¯æŒå¤šä¸ªç§Ÿæˆ·å¹¶å‘æµ‹è¯•
- **è‡ªå®šä¹‰æ¶ˆæ¯**: æ”¯æŒä¸šåŠ¡ç›¸å…³çš„æµ‹è¯•æ¶ˆæ¯
- **æ€§èƒ½åŸºå‡†**: å»ºç«‹æ€§èƒ½åŸºå‡†çº¿
- **è‡ªåŠ¨åŒ–æŠ¥å‘Š**: é›†æˆåˆ°CI/CDæµç¨‹

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [APIé™æµæœºåˆ¶](./production/api-hardening.md)
- [ä¼šè¯ç®¡ç†æ¶æ„](./concepts/sessions.md)
- [LRUå†…å­˜ç®¡ç†](./lru-memory-management.md)
- [æ€§èƒ½ä¼˜åŒ–æ€»ç»“](./optimization_summary.md)
